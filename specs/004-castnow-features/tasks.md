# Tasks: Castnow Feature Integration

**Input**: Design documents from `/specs/004-castnow-features/`
**Prerequisites**: plan.md, spec.md, research.md, data-model.md, contracts/

**Tests**: This feature follows the "Test-First Development" principle from the project constitution. Unit tests for the HTTP server and state transitions are included.

**Organization**: Tasks are grouped by user story to enable independent implementation and testing.

## Format: `[ID] [P?] [Story] Description`

- **[P]**: Can run in parallel (different files, no dependencies)
- **[Story]**: Which user story this task belongs to (e.g., US1, US2, US3)

## Phase 1: Setup (Shared Infrastructure)

**Purpose**: Project initialization and basic structure

- [x] T001 Add `crossterm = "0.27"` to `Cargo.toml`
- [x] T002 [P] Create skeleton files for `src/server.rs` and `src/controllers/tui.rs`
- [x] T003 Register new modules in `src/lib.rs`

---

## Phase 2: Foundational (Blocking Prerequisites)

**Purpose**: Core infrastructure and data structures shared across all features

- [x] T004 [P] Define `MediaSource`, `Playlist`, and `PlaybackStatus` structs in `src/controllers/media.rs`
- [x] T005 [P] Define `TuiCommand` enum in `src/controllers/tui.rs`
- [x] T006 Add `StreamingError` and `TuiError` variants to `src/error.rs`
- [x] T007 [P] Implement MIME type mapping utility in `src/server.rs` per research.md

**Checkpoint**: Core types defined - implementation of user stories can begin.

---

## Phase 3: User Story 3 - Automatic Device Discovery (Priority: P1) ðŸŽ¯ MVP Part A

**Goal**: Automatically find Chromecasts on the network without manual IP entry.

**Independent Test**: Running `cargo run -- scan` should list all active Chromecasts on the subnet.

### Implementation for User Story 3

- [x] T008 [US3] Refactor `src/discovery.rs` to use a non-blocking channel for service events
- [x] T009 [US3] Implement `discover_devices_async` in `src/discovery.rs` returning a stream or receiver
- [x] T010 [US3] Implement the `scan` command logic in `src/main.rs`
- [x] T011 [US3] Add basic error handling for mDNS timeouts in `src/discovery.rs`

---

## Phase 4: User Story 1 - Stream Local Media (Priority: P1) ðŸŽ¯ MVP Part B

**Goal**: Host and stream local video files to a Chromecast device.

**Independent Test**: Providing a local file path to the `cast` command should initiate playback on the device.

### Tests for User Story 1

- [x] T012 [P] [US1] Unit tests for HTTP Range header parsing in `src/server.rs`
- [x] T013 [P] [US1] Unit test for MIME detection in `src/server.rs`

### Implementation for User Story 1

- [x] T014 [US1] Implement `TcpListener` loop and basic HTTP/1.1 response logic in `src/server.rs`
- [x] T015 [US1] Implement Byte-Range file streaming logic in `src/server.rs`
- [x] T016 [US1] Implement the `StreamServer` contract in `src/server.rs`
- [x] T017 [US1] Update `src/controllers/media.rs` to handle local file URLs generated by `StreamServer`
- [x] T018 [US1] Implement the `cast` command for a single file in `src/main.rs`

**Checkpoint**: MVP Complete. Local files can be discovered and cast via CLI.

---

## Phase 5: User Story 2 - Interactive Playback Control (Priority: P2)

**Goal**: Control playback (pause/seek) using keyboard shortcuts.

**Independent Test**: Pressing Space during playback should toggle the pause state on the TV.

### Implementation for User Story 2

- [x] T019 [US2] Implement `crossterm` raw mode setup and key event listener in `src/controllers/tui.rs`
- [x] T020 [US2] Implement `toggle_pause` and `seek` logic in `src/controllers/media.rs`
- [x] T021 [US2] Implement `TuiCommand` transmission from `tui.rs` to `PlaybackSession` in `src/main.rs`
- [x] T022 [US2] Add basic status display (current time / duration) in `src/controllers/tui.rs`

---

## Phase 6: User Story 4 - Playlist Management (Priority: P3)

**Goal**: Automatically play a sequence of files or URLs.

**Independent Test**: Providing two files to `cargo run -- cast` should play them one after the other.

### Implementation for User Story 4

- [x] T023 [US4] Implement `next()` and `previous()` logic in `src/controllers/media.rs`
- [ ] T024 [US4] Implement automatic "next" trigger in `media.rs` when current item finishes (Impl in main loop by monitoring status)
- [x] T025 [US4] Update `src/main.rs` to parse multiple file/URL arguments into a `Playlist`
- [x] T026 [US4] Ensure `StreamServer` updates the served file when the playlist advances

---

## Phase 7: Polish & Cross-Cutting Concerns

**Purpose**: UX improvements and robustness.

- [x] T027 [P] Implement automatic port hunting in `src/server.rs` to avoid conflicts
- [x] T028 [P] Enhance TUI with a progress bar and metadata display in `src/controllers/tui.rs`
- [x] T029 Documentation cleanup in `README.md` and `quickstart.md`
- [x] T030 Final integration test: Perform a full lifecycle scan-and-cast with playlist and controls.

---

## Dependencies & Execution Order

### Phase Dependencies

- **Phase 1 & 2**: Prerequisites for all other work.
- **Phase 3 & 4 (US3 & US1)**: Can be worked on in parallel once Phase 2 is done. Together they form the MVP.
- **Phase 5 (US2)**: Depends on US1 (Streaming) being functional.
- **Phase 6 (US4)**: Depends on US1 (Streaming) being functional.

### Parallel Opportunities

- T002, T004, T005, T007 (Infrastructure definitions)
- T012, T013 (US1 Tests)
- T027, T028 (Polish items)

---

## Implementation Strategy

### MVP First (US3 + US1)

1. Setup mDNS async discovery (US3) so users can find devices.
2. Implement the minimal HTTP server (US1) to serve local content.
3. Connect them in `main.rs` to enable the first "zero-config" cast.

### Incremental TUI

1. Start with a silent background listener for the Space key.
2. Add a simple text status line.
3. Finally, add the progress bar and full visual interface.
