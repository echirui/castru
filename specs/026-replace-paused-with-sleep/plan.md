# Implementation Plan - Replace PAUSED with Auto-Retry Waiting State

**Feature**: Replace PAUSED with Auto-Retry Waiting State
**Feature Branch**: `026-replace-paused-with-sleep`
**Specification**: [specs/026-replace-paused-with-sleep/spec.md](spec.md)

## Technical Context

The current `castru` implementation handles `PAUSED` states in `src/app.rs` by checking `app_state.user_paused`. If true, it enters `PlaybackStatus::Paused` and waits for user interaction. If false, it transitions to `PlaybackStatus::Waiting` (added in feature 025).

This feature requires unifying ALL pause behavior (user-initiated and system-initiated) to use the `Waiting` state with a 10-second auto-resume timer.

### Impact Analysis

- **`src/app.rs`**: Core logic changes in `MediaStatus` handling, `TuiCommand` handlers (`Pause`, `TogglePlay`), and `Watchdog` (recovery logic).
- **`src/controllers/media.rs`**: `PlaybackStatus` enum might need to remove `Paused` or repurpose it. (Given the requirement to *remove* "PAUSED", we should likely remove the variant or make it unreachable/unused, but removing it strictly ensures compliance).
- **`src/controllers/tui.rs`**: UI display logic for `Paused` status needs to be removed/updated to show "WAITING (Resuming in Xs)" or similiar.

### Unknowns & Risks

- **[NEEDS CLARIFICATION: PlaybackStatus::Paused removal]**: Can we strictly remove the `PlaybackStatus::Paused` enum variant, or do we keep it as an "unreachable" state for backward compatibility? (Plan: Attempt to remove it to force compile-time checks of all usage).
- **[NEEDS CLARIFICATION: Timer visualization]**: Does the user want to see the 10s countdown in the UI? (Plan: Yes, it improves UX for "Waiting" state).

## Constitution Check

| Principle | Status | Notes |
|:---|:---:|:---|
| **I. Dependency Minimalism** | ✅ | No new dependencies required. Uses `std::time`. |
| **II. Library-First** | ✅ | Logic is contained in `app.rs` (which consumes library) or library controllers. |
| **III. Test-First** | ✅ | Unit tests for state machine transitions should be updated/added. |
| **IV. Async I/O** | ✅ | `tokio::time::sleep` or `Instant` checks in loop (non-blocking). |
| **V. Secure Transport** | N/A | Feature is purely state management, no transport changes. |

## Gates

- [ ] **Phase 0**: Research complete, unknowns resolved.
- [ ] **Phase 1**: Design complete, data models defined.
- [ ] **Phase 2**: Implementation tasks generated.

---

## Phase 0: Outline & Research

### Research Plan

1. **Verify PlaybackStatus usage**: Search codebase for all usages of `PlaybackStatus::Paused` to identify required changes.
2. **Review Watchdog logic**: Ensure existing recovery logic in 025 can be generalized for manual pauses.

### Findings

#### Decision: Remove PlaybackStatus::Paused
- **Rationale**: The requirement is "Remove all PAUSED". Eliminating the enum variant guarantees this at the compiler level.
- **Impact**: Need to update `src/app.rs`, `src/controllers/media.rs`, `src/controllers/tui.rs`.

#### Decision: Generalize Waiting State
- **Rationale**: Use the existing `Waiting` state (from 025) for everything.
- **Logic**:
  - `last_system_pause_time` in `AppState` should be renamed to `pause_start_time` (since it's now for ALL pauses).
  - When `Pause` command is received -> set `Waiting`, set `pause_start_time`.
  - When `PAUSED` event received -> set `Waiting`, set `pause_start_time` (if not already set).
  - Watchdog checks `Waiting` state:
    - If `now - pause_start_time > 10s` -> `load_media` / `play`.

---

## Phase 1: Design & Contracts

### Data Model Changes

- **`src/controllers/media.rs`**:
  - `PlaybackStatus`: Remove `Paused`.
- **`src/app.rs`**:
  - `AppState`: Rename `last_system_pause_time` -> `pause_start_time`.
  - Remove `user_paused` field (no longer needed distinction).

### API Contracts

No external API changes.

### Quickstart Update

None required.

---

## Phase 2: Implementation Tasks

(To be generated by `speckit.tasks`)